---
title: "Tutorial"
code-fold: true
bibliography: references.bib
author: 
  - name: Dr Nipun Shrestha
    url: https://ctc.usyd.edu.au/about-us/our-people/academics-research-fellows/dr-nipun-shrestha/
    email: drnipunsth@gmail.com
    orcid: 0000-0003-3542-8130
    degrees: 
      - MBBS
      - MPH
      - PhD
google-scholar: true
lightbox: true
---

# Meta-analysis in R

Cord clamping in pre-term babies data from the recently published individual participant data meta analysis is used for this task.[@seidler2023]

::: callout-note
Note that only summary level data is used for this tutorial.
:::

## Loading packages & reading data

First, we need to:\
1. load **packages**\
2. load **data**

::: panel-tabset
#### Loading Packages

```{r library, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(dplyr)
library(metafor)
library (readxl)
```

#### Loading Data

Loading data {this data is located in github repository. <https://github.com/Nipun-Shrestha/Profile_page/blob/main/Icomp.xlsx%7D>

```{r data, warning = FALSE, message = FALSE}
Icomp <- read_excel("Icomp.xlsx")
```
:::

## Calculate log odd ratios and corresponding sampling variances

```{r calculate odds ratio}
dat <- escalc(measure="OR", ai=Icomp$`n_event DCC`, bi=Icomp$n_non_event_DCC, ci=Icomp$`n_event ICC`, di=Icomp$n_non_event_ICC, slab =paste(Icomp$studyid), data=Icomp)
```

## Random-effects model (using log odd ratios and variances as input)

```{r model}
res <- rma(dat$yi, dat$vi, data=dat, method="FE")
```

## Helper function

```{r helper function}
mlabfun <- function(text, res) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(res$QE, digits=2, format="f")),
      ", df = ", .(res$k - res$p),
      ", p ", .(metafor:::.pval(res$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(res$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(res$tau2, digits=2, format="f")), ")")))}
```

## Forest plot

```{r fig.height= 10, fig.width=17, dpi=400}


data_height <- nrow(dat)

#change the left bound after you have run the forest plot once
left_bound <- -8.5
#change the right bound after you have run the forest plot once
right_bound <-4

sav <- forest(res, header=TRUE, xlim=c(left_bound,right_bound), at=log(c(0.5, 0.25, 1, 4)), atransf=exp, ylim=c(-1, (data_height +3)), xlab ="Odds ratio", mlab=mlabfun("RE Model for All Studies", res), ilab=cbind(Icomp$`n_event DCC`, N_DCC, Icomp$`n_event ICC`, Icomp$N_ICC), ilab.xpos=seq(-5.8,-3.8, length = 4), slab=paste(dat$studyid), psize=1)
text(left_bound, data_height+3.5, pos=4, cex=1.3, c("DCC vs ICC Meta-analysis - Death before discharge"), font = 4)
  
text(sav$ilab.xpos, (data_height+2), pos=1, c("Events","Total","Events","Total"), cex = 1.1, font =3)
  
text(c(mean(sav$ilab.xpos[1:2]),mean(sav$ilab.xpos[3:4])), data_height+3, c("DCC","ICC"), pos=1, cex=1.3)

text(c(log(0.15),log(4)), -0.3, pos=1, c("Favours DCC", "Favours ICC"), cex=1.3)
```
